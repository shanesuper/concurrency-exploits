#!/bin/bash

# The following script will build apache 2.0.46 & php-4.4.1

# Step 1: Compile Apache
# Unzip the source file to current folder
if [ -f ../apps/httpd-2.0.48.tar.gz ]
then
    if [ ! -d httpd-2.0.48 ]
    then
        tar xzf ../apps/httpd-2.0.48.tar.gz
    else
        echo "Use existing httpd-2.0.48 source code."
    fi
else
    echo "Missing apache 2.0.48 source file. Check Apps folder."
fi

# configure apache
cd httpd-2.0.48
cp ../before_configure.patch .
patch -p0 < before_configure.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply before_configure.patch" 
    exit 1
fi

#./configure --prefix=`pwd`/../apache-install-gcc --with-mpm=worker --enable-cache -enable-mem-cache CFLAGS="-g"
CFLAGS="-g -O0 -fsanitize=thread" CC="clang" CXX="clang++" ./configure --prefix=`pwd`/../apache-install-tsan --with-mpm=worker --enable-cache -enable-mem-cache

# Apply patch to let apache compile
cp ../after_configure.patch .
patch -p0 < ../after_configure.patch

if [ $? -ne 0 ]
then
    echo "Couldn't apply after_configure.patch" 
    exit 1
fi

make
make install

cd ..
patch -p0 < httpdconfig.patch
if [ $? -ne 0 ]
then
    echo "Couldn't apply httpdconfig.patch" 
    exit 1
fi

echo "Apache compile & configuration done!"

# Step 2: Compile PHP

if [ -f ../apps/php-4.4.1.tar.gz ]
then
    if [ ! -d php-4.4.1 ]
    then
        tar xzf ../apps/php-4.4.1.tar.gz
    else
        echo "Use existing php-4.4.1 source code."
    fi
else
    echo "Missing php-4.4.1 source file. Check the apps folder."
fi

cd php-4.4.1/

./configure --prefix=`pwd`/../apache-install-tsan/php \
    --with-config-file-path=`pwd`/../apache-install-tsan/php \
    --with-mysql --with-apxs2=`pwd`/../apache-install-tsan/bin/apxs

make
make install

test -d `pwd`/../apache-install-tsan/php || mkdir -p `pwd`/../apache-install-tsan/php && cp php.ini-dist `pwd`/../apache-install-tsan/php/php.ini
cp ../pippo.php `pwd`/../apache-install-tsan/htdocs

echo "AddType application/x-httpd-php .php .phtml" >> `pwd`/../apache-install-tsan/conf/httpd.conf 
echo "AddType application/x-httpd-php-source .phps" >> `pwd`/../apache-install-tsan/conf/httpd.conf


echo "Php compile & configuration done!"
