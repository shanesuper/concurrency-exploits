# Chromium - 6.0.472.58
This project is to build chromium-6.0.472.58 with google's thread sanitizer(tsan) in order to detect the race in  [CVE-2010-3412](http://www.cvedetails.com/cve/CVE-2010-3412/)

The experiment is on Ubuntu 14.04

## Build the LLVM, clang and compiler
Follow the same steps to install [LLVM-3.7.1 & clang-3.7.1 and compiler-3.7.1](https://github.com/ruigulala/ConAnalysis#install-llvm-361--clang-361).
However, you need to be attention for two significant modifications.
* Before the step of building LLVM together with Clang using CMake, you must apply a patch which disables the tsan hooks.
```compiler-rt.chromium.patch``` can be found in the source code. Patching for the folder ```compiler-rt``` under ```llvm-3.7.1.src/projects/```
```
patch -p1 < compiler-rt.chromium.patch --dry-run (to check)
patch -p1 < compiler-rt.chromium.patch (to patch)
```
* While come to the step of ```cmake ..```, you need to build with ```-DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=ON```
```
cmake .. -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=ON
```

## Install ```depot_tools``` for using ```gclient``` to build chromium
* Check ```git``` is installed
* Clone ```depot_tools```
```
git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
```
* Add depot_tools to your PATH
```
export PATH=`pwd`/depot_tools:"$PATH"
```

## Build Chromium-6.0.472.58
* Decompress ```6.0.472.58-tsan.tar.gz```. ```6.0.472.58-tsan.tar.gz``` file can be found in the chromium-6.0.472 directory.
```
cd 6.0.472.58-tsan
```
* Use command to configure gclient
```
gclient config https://src.chromium.org/chrome/releases/6.0.472.58
```
* Install dependencies
```
sudo apt-get install libgtk2.0-dev libglib2.0-dev libnss3-dev libgconf2-dev libgnome-keyring-dev libdbus-glib-1-dev libjpeg-dev bison gperf libxss-dev libbz2-dev libswitch-perl libcups2-dev libasound2-dev
```
* Generate the source code of Chromium (DEPS file will configure the Chromium automatically) 
```
gclient sync --force
```
* After waiting for a few mintues, there are two folders generated one is ```chromeos``` the other is called ```src```. Download ```chromium.patch``` to current folder, and patch for the source code.
```
patch -p1 < chromium.patch --dry-run (to check)
patch -p1 < chromium.patch (to patch)
```
* Setup the environment variables
```
export CFLAGS="-no-integrated-as -fPIC -fsanitize=thread -gline-tables-only"
export CXXFLAGS="$CFLAGS"
export LDFLAGS="-pie -fsanitize=thread -gline-tables-only -Wl,--allow-multiple-definition"
export CC=/your/path/clang
export CXX=/your/path/clang++
```
* Go to ```src```
```
cd ./src
```
* Generate a executable at ```./src/out/Debug/chrome```
```
GYP_DEFINES="werror=" ./build/gyp_chromium
make -j`nproc` chrome
```

## Test Chromium
* Set the ```TSAN_OPTIONS```
```
export TSAN_OPTIONS="exitcode=0 log_path=/your/path/error_log.log"
```
* Run Chromium with Tsan, there are some error logs at your path
```
./out/Debug/chrome
```

## Test [CVE-2010-3412](http://www.cvedetails.com/cve/CVE-2010-3412/)
* Run the test case [console profiles](https://bugs.chromium.org/p/chromium/issues/detail?id=51919)
```
Create two htm files console.htm and index.htm and run with Chromium

-----console.htm----
<script>
window.console.profile(document.createElement("td"),eval,null,null);
window.console.profile(1000000000,window.console.time);
window.console.profile(null,null,1000000000);
</script>
------index.htm-----
<META HTTP-EQUIV="refresh" CONTENT="0;url=index.htm">
<iframe src="console.htm"></iframe>
```

## FAQ
* During generating a executable at ```./src/out/Debug/chrome```, you may face some compiler errors about being lack of certain dependencies. Do not worry about that, you should find the libraries first according to the error message. Then, install the related dependencies. Finally, you fix the problems by yourself.
```
sudo apt-get install -f
sudo apt-get install "dependencies"
```

## Some comments
Thanks for the helpful guidance from Bo and Rui, if you have encountered any problems, please do not hesitate to send an email to [Clark YAN (me)](https://github.com/ClarkYan) at clarkyan1993@gmail.com or opening an issue on github.



